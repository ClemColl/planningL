<%= render 'indicateurs/labels' %>
<script>
Chart.defaults.global.plugins.datalabels = {
    color: 'white',
    font: { size: 10, weight: 'bold' },
    display: function(context) {
        if (context.dataset.type == 'bar') {
            return context.dataset.data[context.dataIndex];
        } else {
            return 0
        }
    }
}
</script>

<h1>Suivi d'activité</h1>

<p>Aujourd'hui nous sommes en semaine <%= Date.today.cweek %></p>

<div class="row" style="margin-top:50px;">
    <div class="col-md-4">
        <% @machines.each do |m| %>
            <div class="btn-group", style="width:100%;">
                <%= link_to "#{m.name} - #{m.last_week}", new_machine_rapport_path(m.id), class:"btn btn-default", style: "width:70%;" %>
                <%= link_to "X", machine_path(m), class:"btn btn-danger", method: :delete, confirm: "Êtes vous sûr?", style:"width:10%;"%>
            </div>
        <% end %>
            
            <%= link_to "Nouvelle machine", new_machine_path, class: "col-4 btn btn-info btn-block", style:'margin-top:5px;' %>
            
    </div>

    <div class="col-md-4">
        <div class="btn-group", style="width:100%;">
            <%= link_to "Etat du stock - #{@stock_last_week}", new_stock_path, class:"btn btn-default", style:"width:80%;" %>
            <%= link_to "Modifier", edit_stock_path(Stock.last.id), class:"btn btn-default", style:"width:20%;" if Stock.exists? %>
        </div>
    </div>

    <div class="col-md-4">
        <div class="btn-group", style="width:100%;">
            <%= link_to "Consommables et pièces - #{@backlog_last_week}", new_backlog_path, class:"btn btn-default", style:"width:80%;" %>
            <%= link_to "Modifier", edit_backlog_path(Backlog.last.id), class:"btn btn-default", style:"width:20%;" if Backlog.exists? %>
        </div>
    </div>

</div>
<%= form_tag suivi_path, { :method => :post, style: 'margin-top:100px;margin-bottom:100px;' } do %>
    <div class="row">
        <div class="col-md-4 col-md-offset-4">
        <%= submit_tag "Chargement...", id: "get_pdf",
                                        class: "btn btn-primary",
                                        disabled: true,
                                        data: { disable_with: false } %>
        <%= link_to 'Modifier les données', suivi_bugfix_path, class: 'btn btn-danger', style: 'margin-left:10px;' %>
        </div>
    </div>

    <% @machines.each do |m| %>
        <%= hidden_field_tag "#{m.underscore_id}_base64".to_sym %>
    <% end %>    
    <%= hidden_field_tag "stock_base64".to_sym %>
    <%= hidden_field_tag "backlog_base64".to_sym %>
    <%= hidden_field_tag "ytd_base64".to_sym %>
    <%# text_field_tag %>
<% end %>

<% @machines.each do |m| %>
    <canvas id="<%= m.underscore_id %>" style="display: inline-block;"></canvas>
<% end %>
<canvas id="stock" style="display: inline-block;"></canvas>
<canvas id='backlog' style="display: inline-block;"></canvas>
<canvas id='ytd' style="display: inline-block;"></canvas>

<% @rapports.each do |r| %>

<% m_id = r.first.machine.underscore_id %>
<script>
var ctx = document.getElementById("<%= m_id %>").getContext('2d');
var <%= m_id %> = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: <%= raw @date_range + ["T+1"] %>,
        datasets: [{
            label: 'PDP',
            type: 'line',
            data: <%= r.pluck(:pdp).map(&:to_i) %>,
            borderColor: "#5E9CD3",
            backgroundColor: "#5E9CD3",
            fill: false
        },
        {
            label: 'PDP+1',
            type: 'bar',
            data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, <%= r.last.next_pdp %>],
            borderColor: 'red',
            backgroundColor: 'red'
        },
        {
            label: 'Commandes totale affectées + 1',
            data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, <%= r.each.sum{|ra| ra.next_cas} %>],
            borderColor: 'grey',
            backgroundColor: 'grey',
            type: 'bar'
        },
        {
            label: "Deals signés en attente d'acompte",
            data: <%= r.pluck(:dsa).map(&:to_i) %>,
            borderColor: '#4674C1',
            backgroundColor: '#4674C1',
            lineTension: 0,
            type: 'line',
            fill: false  
        },
        {
            label: 'DAV',
            data: <%= r.pluck(:dav).map(&:to_i) %>,
            borderColor: '#FDBF2D',
            backgroundColor: '#FDBF2D',
            type: 'line',
            fill: false
        },
        {
            label: 'Commandes totale affectées',
            data: <%= r.pluck(:cta).map(&:to_i) %>,
            borderColor: '#EA7D3C',
            backgroundColor: '#EA7D3C'
        },
        {
            label: 'Commandes  affectées dans la semaine',
            data: <%= r.pluck(:cas).map(&:to_i) %>,
            borderColor: '#94CE58',
            backgroundColor: '#94CE58'
        }]
    },
    options: {
        animation: { duration: 0 },
        spanGaps: true,
        responsive: false,
        maintainAspectRatio: false,
        legend: { display: false },
        onAnimationComplete: setTimeout( function() {
            var dataURL = <%= m_id %>.toBase64Image();
            $('#<%= m_id %>_base64').val(dataURL);
            },1000),
        scales: {
            yAxes: [{
                ticks: { beginAtZero: true, stepSize: <%= (r.last.next_pdp/5).to_i %> }
            }],
            xAxes: [{
                barThickness: 10,
                gridLines: { offsetGridLines: true, display: false }
            }],
        },
        elements: {
            line: { tension: 0 },
            point: { radius: 3 }
        },
        title: { display: true, text: 'Activité <%= r.first.machine.name %>', fontSize: 30 }
    }});
</script>
    
<% end %>

<%= render 'static/charts/stock' %>

<%= render 'static/charts/backlog' %>

<script>
setTimeout(() => {
    $("#get_pdf").prop('value', 'Rapport PDF');
    $("#get_pdf").prop( "disabled", false );
}, 2000);
</script>
